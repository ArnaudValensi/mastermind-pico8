pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
lvls={}
lvindex=0
currentlv=nil
startgame=true
endgame=false

p={}
p.x=0
p.y=0

function _init()
 create_lvls()
 
	p.x=currentlv.spawn[1]
	p.y=currentlv.spawn[2]
	
	sfx(6)
end

function lvl_max_x(sx,sy)
	for x=sx,127 do
	 local cel=mget(x,sy)
	 if cel==0 then
	 	return x-1
	 end
	end
	
	return 127
end

function lvl_max_y(sx,sy)
	for y=sy,31 do
		local cel=mget(sx,y)
	 if cel==0 then
	 	return y-1
	 end
	end
	
	return 31
end

function find_cel(sx,sy,mx,my,cel)
 for x=sx,mx do
 	for y=sy,my do
 		if mget(x,y) == cel then
 			return {x,y}
 		end
 	end
 end	
end

function create_lvls()
	local sx=0
 local sy=0
 
 while sx<128 do
  local cel=mget(sx,y)
  if cel != 0 then
	 	local mx=lvl_max_x(sx,sy)
   local my=lvl_max_y(sx,sy)
 
	  local lvl={}
	  lvl.rect={sx,sy,mx,my}
	  lvl.spawn=find_cel(sx,sy,mx,my,19)
	  lvl.exit=find_cel(sx,sy,mx,my,20)
	
	  lvls[#lvls+1]=lvl
	  sx=mx
	 end
	 
	 sx=sx+1
	end
	
	lvindex=1
	currentlv=lvls[lvindex]
end

function _update()
	if endgame then
		return
	end

	if btnp(0) then
		move(-1,0)
	elseif btnp(1) then
	 move(1,0)
	elseif btnp(2) then
	 move(0,-1)
	elseif btnp(3) then
	 move(0,1)
	elseif btnp(❎) then
		p.x=currentlv.spawn[1]
	 p.y=currentlv.spawn[2]
	end
end

function move(dirx,diry)
	local mult=mget(p.x,p.y)
	if mult<1 or mult>5 then
		mult=1
	end
	
	local dcx=p.x+dirx*mult
	local dcy=p.y+diry*mult
	
	if dcx > currentlv.rect[3]
	or dcy > currentlv.rect[4]
	or dcx < currentlv.rect[1]
	or dcy < currentlv.rect[2]
	then
		sfx(4)
		return
	end
	
	local destcel=mget(
	 dcx,
	 dcy
	)
	
	if destcel == 18 then
	sfx(4)
		return
	end
	
	p.x=dcx
	p.y=dcy
	sfx(0)
	
	if destcel == 20 then
		load_next_lvl()
		return
	end
end

function load_next_lvl()
	lvindex=lvindex+1
	currentlv=lvls[lvindex]
	
	if currentlv == nil then
		endgame=true
		--music(-1)
		sfx(5)
		return
	end
	
	p.x=currentlv.spawn[1]
	p.y=currentlv.spawn[2]
end

function _draw() 
	draw_bg()
	
	if startgame then
		draw_text(
		 "saddly,",
		 128/2,
		 42
		)
		draw_text(
		 "you are trapped",
		 128/2,
		 52
		)
		draw_text(
		 "in the rainbow dungeon.",
		 128/2,
		 62
		)
		draw_text(
		 "press ⬆️,⬇️,⬅️ or ➡️",
		 128/2-8,
		 92
		)
		
		if btnp(⬆️)
		or btnp(⬇️)
		or btnp(⬅️)
		or btnp(➡️)
		then
			startgame=false
			--music(0)
		end
		
		return
	end
	
	if endgame then
		draw_text(
		 "you finally reached freedom",
		 128/2,
		 128/2-5
		)
		draw_text(
		 "well done!",
		 128/2,
		 128/2+5
		)
		return
	end
	
	local lv=currentlv
	
	local mx=lv.rect[1]
	local my=lv.rect[2]
	local msizex=lv.rect[3]-mx+1
	local msizey=lv.rect[4]-my+1
	local sx=0
	local sy=0
	local offsetx=(16-msizex)/2*8
	local offsety=(16-msizey)/2*8
	
	map(
	 mx,
	 my,
	 sx+offsetx,
	 sy+offsety,
	 msizex,
	 msizey
	)
	
	local px=p.x-lv.rect[1]
	local py=p.y-lv.rect[2]
	spr(
	 17,
	 px*8+offsetx,
	 py*8+offsety
	)
	
	draw_text(
		"❎ to retry",
		128/2-2,
		128-24
	)
	
	local cel=mget(p.x,p.y)
	printh(cel)
	if cel>0 and cel<6 then
		sspr(cel*8,0,8,8,56,0,16,16)
	end
end

function draw_text(str,x,y,al,extra,c1,c2)
    str = ""..str
    local al = al or 1
    local c1 = c1 or 7
    local c2 = c2 or 13

    if al == 1 then x -= #str * 2 - 1
    elseif al == 2 then x -= #str * 4 end

    y -= 3

    if extra then
        print(str,x,y+3,0)
        print(str,x-1,y+2,0)
        print(str,x+1,y+2,0)
        print(str,x-2,y+1,0)
        print(str,x+2,y+1,0)
        print(str,x-2,y,0)
        print(str,x+2,y,0)
        print(str,x-1,y-1,0)
        print(str,x+1,y-1,0)
        print(str,x,y-2,0)
    end

    print(str,x+1,y+1,c2)
    print(str,x-1,y+1,c2)
    print(str,x,y+2,c2)
    print(str,x+1,y,c1)
    print(str,x-1,y,c1)
    print(str,x,y+1,c1)
    print(str,x,y-1,c1)
    print(str,x,y,0)
end

t=0
function draw_bg()
 t+=0.02
 
 for i=0,1000 do
  local x,y=rnd(128),rnd(128)
  local c=(x/16+y/32+t)%6+8
  circfill(x,y,1,c)
 end
end
__gfx__
00000000333333333333333333333333333333333333333300000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000332333333323323333233233332332333323323300000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700333333333333333333333333333333333333333300000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000333333333333333333233333332332333323323300000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000333333333333333333333333333333333333333300000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700333333333333333333333333333333333333323300000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000333333333333333333333333333333333333333300000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000333333333333333333333333333333333333333300000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333006006005555555511111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333066666605666666711111111156111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333065665605666666711111111156561110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333006666005666666711111111156565610000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333006556005666666711111111156565610000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333000660005666666711111111156565610000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333006666005666666711111111156565610000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333000660005777777711111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
1212121212121212121200121212121212121200121212121200121212121212121212121212121200121212121212121212000000000000000000000000000000121212001212121212121212121212121212000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1213101010101010101200121310020112121200121010131200121310101010100202120310051200121304040202020512000000000000000000000000000000121312001213101010101010101010101412000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1212121212121212101200121012120101121200121410101200121012121212020502121012011200121205010203010212000000000000000000000000000000121012001212121212121212121212121212000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1210101010100210101200121212010210121200121212121200121012021004121212121212011200121203030302030412000000000000000000000000000000121012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1210121212121212121200121212121214121200000000000000121012120410120303120312051200121202010202030512000000000000000000000000000000121012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1210100310101010101200121212121212121200000000000000121010100212120312120312031200121203030303040112000000000000000000000000000000121012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1212121212121212101200000000000000000000000000000000121012121212051210101012101200121204030503051412000000000000000000000000000000121012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1214101010120210101200000000000000000000000000000000120312101012121205121212041200121212121212121212000000000000000000000000000000121412000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1212121212121212121200000000000000000000000000000000121012021210101010100310141200000000000000000000000000000000000000000000000000121212000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000121212121212121212121212121200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000121212121212121212121200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000121303030403031212121200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000120401050402031212121200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000120302040312121212121200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000120202020303030504141200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000120303030312121212121200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000120102040204041212121200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000120205030503011212121200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000121212121212121212121200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
0001000015050180501b0502105026050290502a050110500c0500605002050000500305002050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001e00001b0501c0502405026050290500005021050200500005017050160500005000050000500005027050260502705001050280502905019050170500005000050000500c050000500c0500b0501505000050
00100000200502005020050200500000000000240502b0502b0502b0502c0502c0502a0502705027050000001f0501d050190501605015050140501205001050000001f0501e0501f0501e0501f0502705027050
001e00000405004050040500305002050020500305003050030500305002050020500405005050030500305003050030500305003050030500105001050010500205003050030500205002050030500305003050
000100000955009550095500955009550095500955009550055500555005550045500255000550005500955009550095500955009550095500955009550025500255002550025500155001550015500155000550
0006000019550195501955019550265502655026550265501a5501a5501a5501a5502b5502b5502b5502b5502b5502b5502b5502b550315503155031550315502b5502b550305503055030550305503055030550
001000001b050200502205023050230501b050200502205023050230500c050110501305014050140500c050110501305014050140501c050200502205023050230500c050130501a0501d0501f0501f00000000
__music__
02 03424344

